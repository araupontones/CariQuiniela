pre_rating)
final <- db %>%
left_join(oponents, by = c('date', 'opponent'), suffix =c("_team", "_opponent"))
}
tablita <- matches %>%
get_pre_rating(., elos)
elos <- rio::import("elo/pre_wc_ratings.csv") %>% select(-year)
elos <- rio::import("elo/pre_wc_ratings.csv")
get_pre_rating <- function(.data, elos){
db <- .data %>%
group_by(team) %>%
arrange(team, desc(year), desc(date)) %>%
mutate(last_match= lead(date)) %>%
ungroup() %>%
left_join(elos, by = c("team", "last_match"="date")) %>%
rename(pre_rating = rating)
oponents <- db %>%
select(opponent = team,
date,
pre_rating)
final <- db %>%
left_join(oponents, by = c('date', 'opponent'), suffix =c("_team", "_opponent"))
}
get_pre_rating <- function(.data, elos){
db <- .data %>%
group_by(team) %>%
arrange(team, desc(year), desc(date)) %>%
mutate(last_match= lead(date)) %>%
ungroup() %>%
left_join(elos, by = c("team", "last_match"="date")) %>%
rename(pre_rating = rating)
#
# oponents <- db %>%
#   select(opponent = team,
#          date,
#          pre_rating)
#
#
# final <- db %>%
#   left_join(oponents, by = c('date', 'opponent'), suffix =c("_team", "_opponent"))
#
}
tablita <- matches %>%
get_pre_rating(., elos)
View(tablita)
tablita <- matches %>%
select(date, year, opponent, goles_team, goles_opponent) %>%
get_pre_rating(., elos)
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent) %>%
get_pre_rating(., elos)
get_pre_rating <- function(.data, elos){
db <- .data %>%
group_by(team) %>%
arrange(team, desc(year), desc(date)) %>%
mutate(last_match= lead(date)) %>%
ungroup() %>%
left_join(elos, by = c("team", "last_match"="date")) %>%
rename(pre_rating = rating)
#
oponents <- db %>%
select(opponent = team,
date,
pre_rating)
final <- db %>%
left_join(oponents, by = c('date', 'opponent'), suffix =c("_team", "_opponent"))
}
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent) %>%
get_pre_rating(., elos)
result <- function(GF, GA){
case_when(GF > GA ~ "W",
GF < GA ~ "L",
GF == GA ~ "D"
)
}
diff_ratings <- function(rating_team, rating_opponent){
dr = rating_team - rating_opponent
1/(10^(-dr/400) +1)
}
elo_score <- function(R_0, k, result, diff_ratings){
w = case_when(result == "W" ~ 1,
result == "D" ~ 0.5,
result == "L" ~ 0)
round(R_0 + k * (w-diff_ratings))
}
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent) %>%
get_pre_rating(., elos) %>%
#rename variables to ease its analysis
rename(GF = goles_team,
GA = goles_opponent
) %>%
#create indicators  by team------------------------------------------------------------
group_by(team) %>%
arrange(team, desc(year),desc(date)) %>%
mutate(
ind_did_score = suma_rol(GF>0),
ind_fail_to_score = suma_rol(GF==0),
ind_did_receive_goal = suma_rol(GA>0),
ind_not_receive_goal = suma_rol(GA==0),
ind_GF_last_5 = rollsum(GF, 5,align = 'left', fill = NA),
ind_GA_last_5 = rollsum(GA, 5,align = 'left', fill = NA),
#so take the ones before the match
across(starts_with("ind"), ~lead(.x)),
.after = GA ) %>%
ungroup()%>%
select(date, year, team, opponent,GF,GA, starts_with("ind"), starts_with("pre"),qatar) %>%
rename_at(vars(starts_with("ind_")), function(x)str_remove_all(x,"ind_")) %>%
filter(year > 2017) %>%
#calculate elo
mutate(
result = result(GF, GA),
magic_johnson = diff_ratings(pre_rating_team,pre_rating_opponent),
rating = elo_score(pre_rating_team, 60, result, magic_johnson)
)
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent,qatar) %>%
get_pre_rating(., elos) %>%
#rename variables to ease its analysis
rename(GF = goles_team,
GA = goles_opponent
) %>%
#create indicators  by team------------------------------------------------------------
group_by(team) %>%
arrange(team, desc(year),desc(date)) %>%
mutate(
ind_did_score = suma_rol(GF>0),
ind_fail_to_score = suma_rol(GF==0),
ind_did_receive_goal = suma_rol(GA>0),
ind_not_receive_goal = suma_rol(GA==0),
ind_GF_last_5 = rollsum(GF, 5,align = 'left', fill = NA),
ind_GA_last_5 = rollsum(GA, 5,align = 'left', fill = NA),
#so take the ones before the match
across(starts_with("ind"), ~lead(.x)),
.after = GA ) %>%
ungroup()%>%
select(date, year, team, opponent,GF,GA, starts_with("ind"), starts_with("pre"),qatar) %>%
rename_at(vars(starts_with("ind_")), function(x)str_remove_all(x,"ind_")) %>%
filter(year > 2017) %>%
#calculate elo
mutate(
result = result(GF, GA),
magic_johnson = diff_ratings(pre_rating_team,pre_rating_opponent),
rating = elo_score(pre_rating_team, 60, result, magic_johnson)
)
ratings <- tablita %>%
select(date, year, team, magic_johnson, rating) %>%
filter(!is.na(magic_johnson)) %>%
arrange(team,desc(year), desc(date))
rio::export(ratings, "data/3.clean/elo_ratings.csv")
ratings <- tablita %>%
select(date, team, magic_johnson, rating) %>%
filter(!is.na(magic_johnson)) %>%
arrange(team, desc(date))
rio::export(ratings, "data/3.clean/elo_ratings.csv")
ratings <- tablita %>%
select(date, team, rating) %>%
filter(!is.na(magic_johnson)) %>%
arrange(team, desc(date))
ratings <- tablita %>%
select(date, team, rating) %>%
filter(!is.na(rating)) %>%
arrange(team, desc(date))
rio::export(ratings, "data/3.clean/elo_ratings.csv")
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent,qatar) %>%
get_pre_rating(., elos)
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent,qatar) %>%
get_pre_rating(., elos)
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent,qatar) %>%
get_pre_rating(., elos) %>%
#rename variables to ease its analysis
rename(GF = goles_team,
GA = goles_opponent
) %>%
#create indicators  by team------------------------------------------------------------
group_by(team) %>%
arrange(team, desc(year),desc(date)) %>%
mutate(
ind_did_score = suma_rol(GF>0),
ind_fail_to_score = suma_rol(GF==0),
ind_did_receive_goal = suma_rol(GA>0),
ind_not_receive_goal = suma_rol(GA==0),
ind_GF_last_5 = rollsum(GF, 5,align = 'left', fill = NA),
ind_GA_last_5 = rollsum(GA, 5,align = 'left', fill = NA),
#so take the ones before the match
across(starts_with("ind"), ~lead(.x)),
.after = GA ) %>%
ungroup()%>%
select(date, year, team, opponent,GF,GA, starts_with("ind"), starts_with("pre"),qatar) %>%
rename_at(vars(starts_with("ind_")), function(x)str_remove_all(x,"ind_")) %>%
filter(year > 2017) %>%
#calculate elo
mutate(
result = result(GF, GA),
magic_johnson = diff_ratings(pre_rating_team,pre_rating_opponent),
rating = elo_score(pre_rating_team, 60, result, magic_johnson)
)
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent,qatar) %>%
get_pre_rating(., elos) %>%
#rename variables to ease its analysis
rename(GF = goles_team,
GA = goles_opponent
) %>%
#create indicators  by team------------------------------------------------------------
group_by(team) %>%
arrange(team, desc(year),desc(date)) %>%
mutate(
ind_did_score = suma_rol(GF>0),
ind_fail_to_score = suma_rol(GF==0),
ind_did_receive_goal = suma_rol(GA>0),
ind_not_receive_goal = suma_rol(GA==0),
ind_GF_last_5 = rollsum(GF, 5,align = 'left', fill = NA),
ind_GA_last_5 = rollsum(GA, 5,align = 'left', fill = NA),
#so take the ones before the match
across(starts_with("ind"), ~lead(.x)),
.after = GA ) %>%
ungroup()%>%
select(date, year, team, opponent,GF,GA, starts_with("ind"), starts_with("pre"),qatar) %>%
rename_at(vars(starts_with("ind_")), function(x)str_remove_all(x,"ind_")) %>%
filter(year > 2017) %>%
#calculate elo
mutate(
result = result(GF, GA),
magic_johnson = diff_ratings(pre_rating_team,pre_rating_opponent),
rating = elo_score(pre_rating_team, 60, result, magic_johnson)
)
ratings <- tablita %>%
select(date, team, rating) %>%
filter(!is.na(rating)) %>%
arrange(team, desc(date))
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent,qatar) %>%
get_pre_rating(., ratings) %>%
#rename variables to ease its analysis
rename(GF = goles_team,
GA = goles_opponent
) %>%
#create indicators  by team------------------------------------------------------------
group_by(team) %>%
arrange(team, desc(year),desc(date)) %>%
mutate(
ind_did_score = suma_rol(GF>0),
ind_fail_to_score = suma_rol(GF==0),
ind_did_receive_goal = suma_rol(GA>0),
ind_not_receive_goal = suma_rol(GA==0),
ind_GF_last_5 = rollsum(GF, 5,align = 'left', fill = NA),
ind_GA_last_5 = rollsum(GA, 5,align = 'left', fill = NA),
#so take the ones before the match
across(starts_with("ind"), ~lead(.x)),
.after = GA ) %>%
ungroup()%>%
select(date, year, team, opponent,GF,GA, starts_with("ind"), starts_with("pre"),qatar) %>%
rename_at(vars(starts_with("ind_")), function(x)str_remove_all(x,"ind_")) %>%
filter(year > 2017) %>%
#calculate elo
mutate(
result = result(GF, GA),
magic_johnson = diff_ratings(pre_rating_team,pre_rating_opponent),
rating = elo_score(pre_rating_team, 60, result, magic_johnson)
)
ratings <- tablita %>%
select(date, team, rating) %>%
filter(!is.na(rating)) %>%
arrange(team, desc(date))
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent,qatar) %>%
get_pre_rating(., ratings) %>%
#rename variables to ease its analysis
rename(GF = goles_team,
GA = goles_opponent
) %>%
#create indicators  by team------------------------------------------------------------
group_by(team) %>%
arrange(team, desc(year),desc(date)) %>%
mutate(
ind_did_score = suma_rol(GF>0),
ind_fail_to_score = suma_rol(GF==0),
ind_did_receive_goal = suma_rol(GA>0),
ind_not_receive_goal = suma_rol(GA==0),
ind_GF_last_5 = rollsum(GF, 5,align = 'left', fill = NA),
ind_GA_last_5 = rollsum(GA, 5,align = 'left', fill = NA),
#so take the ones before the match
across(starts_with("ind"), ~lead(.x)),
.after = GA ) %>%
ungroup()%>%
select(date, year, team, opponent,GF,GA, starts_with("ind"), starts_with("pre"),qatar) %>%
rename_at(vars(starts_with("ind_")), function(x)str_remove_all(x,"ind_")) %>%
filter(year > 2017) %>%
#calculate elo
mutate(
result = result(GF, GA),
magic_johnson = diff_ratings(pre_rating_team,pre_rating_opponent),
rating = elo_score(pre_rating_team, 60, result, magic_johnson)
)
elos <- rio::import("elo/pre_wc_ratings.csv")
View(elos)
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent,qatar) %>%
group_by(team) %>%
mutate(previous_match = lag(date)) %>%
left_join(elos, by= c("prev_match" = "date", "team") )
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent,qatar) %>%
group_by(team) %>%
mutate(prev_match = lag(date)) %>%
left_join(elos, by= c("prev_match" = "date", "team") )
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent,qatar) %>%
#rename variables to ease its analysis
rename(GF = goles_team,
GA = goles_opponent
) %>%
#create indicators  by team------------------------------------------------------------
group_by(team) %>%
arrange(team, desc(year),desc(date)) %>%
mutate(
ind_did_score = suma_rol(GF>0),
ind_fail_to_score = suma_rol(GF==0),
ind_did_receive_goal = suma_rol(GA>0),
ind_not_receive_goal = suma_rol(GA==0),
ind_GF_last_5 = rollsum(GF, 5,align = 'left', fill = NA),
ind_GA_last_5 = rollsum(GA, 5,align = 'left', fill = NA),
#so take the ones before the match
across(starts_with("ind"), ~lead(.x)),
.after = GA ) %>%
ungroup()%>%
select(date, year, team, opponent,GF,GA, starts_with("ind"),qatar) %>%
rename_at(vars(starts_with("ind_")), function(x)str_remove_all(x,"ind_")) %>%
filter(year > 2017) %>%
#calculate elo
mutate(
result = result(GF, GA),
magic_johnson = diff_ratings(pre_rating_team,pre_rating_opponent),
rating = elo_score(pre_rating_team, 60, result, magic_johnson)
)
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent,qatar) %>%
#rename variables to ease its analysis
rename(GF = goles_team,
GA = goles_opponent
) %>%
#create indicators  by team------------------------------------------------------------
group_by(team) %>%
arrange(team, desc(year),desc(date)) %>%
mutate(
ind_did_score = suma_rol(GF>0),
ind_fail_to_score = suma_rol(GF==0),
ind_did_receive_goal = suma_rol(GA>0),
ind_not_receive_goal = suma_rol(GA==0),
ind_GF_last_5 = rollsum(GF, 5,align = 'left', fill = NA),
ind_GA_last_5 = rollsum(GA, 5,align = 'left', fill = NA),
#so take the ones before the match
across(starts_with("ind"), ~lead(.x)),
.after = GA ) %>%
ungroup()%>%
select(date, year, team, opponent,GF,GA, starts_with("ind"),qatar) %>%
rename_at(vars(starts_with("ind_")), function(x)str_remove_all(x,"ind_")) %>%
filter(year > 2017)
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent,qatar) %>%
#rename variables to ease its analysis
rename(GF = goles_team,
GA = goles_opponent
) %>%
#create indicators  by team------------------------------------------------------------
group_by(team) %>%
arrange(team, desc(year),desc(date)) %>%
mutate(
ind_did_score = suma_rol(GF>0),
ind_fail_to_score = suma_rol(GF==0),
ind_did_receive_goal = suma_rol(GA>0),
ind_not_receive_goal = suma_rol(GA==0),
ind_GF_last_5 = rollsum(GF, 5,align = 'left', fill = NA),
ind_GA_last_5 = rollsum(GA, 5,align = 'left', fill = NA),
#so take the ones before the match
across(starts_with("ind"), ~lead(.x)),
.after = GA ) %>%
select(date, year, team, opponent,GF,GA, starts_with("ind"),qatar) %>%
rename_at(vars(starts_with("ind_")), function(x)str_remove_all(x,"ind_")) %>%
filter(year > 2017) %>%
ungroup()
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent,qatar) %>%
#rename variables to ease its analysis
rename(GF = goles_team,
GA = goles_opponent
) %>%
#create indicators  by team------------------------------------------------------------
group_by(team) %>%
arrange(team, desc(year),desc(date)) %>%
mutate(
ind_did_score = suma_rol(GF>0),
ind_fail_to_score = suma_rol(GF==0),
ind_did_receive_goal = suma_rol(GA>0),
ind_not_receive_goal = suma_rol(GA==0),
ind_GF_last_5 = rollsum(GF, 5,align = 'left', fill = NA),
ind_GA_last_5 = rollsum(GA, 5,align = 'left', fill = NA),
prev_date = lag(date),
#so take the ones before the match
across(starts_with("ind"), ~lead(.x)),
.after = GA ) %>%
select(date, year, team, opponent,GF,GA, starts_with("ind"),qatar, prev_date) %>%
rename_at(vars(starts_with("ind_")), function(x)str_remove_all(x,"ind_")) %>%
filter(year > 2017) %>%
ungroup()
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent,qatar) %>%
#rename variables to ease its analysis
rename(GF = goles_team,
GA = goles_opponent
) %>%
#create indicators  by team------------------------------------------------------------
group_by(team) %>%
arrange(team, desc(year),desc(date)) %>%
mutate(
ind_did_score = suma_rol(GF>0),
ind_fail_to_score = suma_rol(GF==0),
ind_did_receive_goal = suma_rol(GA>0),
ind_not_receive_goal = suma_rol(GA==0),
ind_GF_last_5 = rollsum(GF, 5,align = 'left', fill = NA),
ind_GA_last_5 = rollsum(GA, 5,align = 'left', fill = NA),
prev_date = lag(date),
#so take the ones before the match
across(starts_with("ind"), ~lead(.x)),
.after = GA ) %>%
select(date, year, team, opponent,GF,GA, starts_with("ind"),qatar, prev_date) %>%
rename_at(vars(starts_with("ind_")), function(x)str_remove_all(x,"ind_")) %>%
filter(year > 2017) %>%
ungroup() %>%
left_join(elos, by = c("prev_date" = "date"))
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent,qatar) %>%
#rename variables to ease its analysis
rename(GF = goles_team,
GA = goles_opponent
) %>%
#create indicators  by team------------------------------------------------------------
group_by(team) %>%
arrange(team, desc(year),desc(date)) %>%
mutate(
ind_did_score = suma_rol(GF>0),
ind_fail_to_score = suma_rol(GF==0),
ind_did_receive_goal = suma_rol(GA>0),
ind_not_receive_goal = suma_rol(GA==0),
ind_GF_last_5 = rollsum(GF, 5,align = 'left', fill = NA),
ind_GA_last_5 = rollsum(GA, 5,align = 'left', fill = NA),
prev_date = lag(date),
#so take the ones before the match
across(starts_with("ind"), ~lead(.x)),
.after = GA ) %>%
select(date, year, team, opponent,GF,GA, starts_with("ind"),qatar, prev_date) %>%
rename_at(vars(starts_with("ind_")), function(x)str_remove_all(x,"ind_")) %>%
filter(year > 2017) %>%
ungroup() %>%
left_join(elos, by = c("prev_date" = "date", "team"))
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent,qatar) %>%
#rename variables to ease its analysis
rename(GF = goles_team,
GA = goles_opponent
) %>%
#create indicators  by team------------------------------------------------------------
group_by(team) %>%
arrange(team, desc(year),desc(date)) %>%
mutate(
ind_did_score = suma_rol(GF>0),
ind_fail_to_score = suma_rol(GF==0),
ind_did_receive_goal = suma_rol(GA>0),
ind_not_receive_goal = suma_rol(GA==0),
ind_GF_last_5 = rollsum(GF, 5,align = 'left', fill = NA),
ind_GA_last_5 = rollsum(GA, 5,align = 'left', fill = NA),
prev_date = lag(date),
#so take the ones before the match
across(starts_with("ind"), ~lead(.x)),
.after = GA ) %>%
select(date, year, team, opponent,GF,GA, starts_with("ind"),qatar, prev_date) %>%
rename_at(vars(starts_with("ind_")), function(x)str_remove_all(x,"ind_")) %>%
filter(year > 2017) %>%
ungroup()
sum(is.na(prev_date))
sum(is.na(tablita$prev_date))
tablita <- matches %>%
select(date, year, team,opponent, goles_team, goles_opponent,qatar) %>%
#rename variables to ease its analysis
rename(GF = goles_team,
GA = goles_opponent
) %>%
#create indicators  by team------------------------------------------------------------
group_by(team) %>%
arrange(team, desc(year),desc(date)) %>%
mutate(
ind_did_score = suma_rol(GF>0),
ind_fail_to_score = suma_rol(GF==0),
ind_did_receive_goal = suma_rol(GA>0),
ind_not_receive_goal = suma_rol(GA==0),
ind_GF_last_5 = rollsum(GF, 5,align = 'left', fill = NA),
ind_GA_last_5 = rollsum(GA, 5,align = 'left', fill = NA),
prev_date = lag(date),
#so take the ones before the match
across(starts_with("ind"), ~lead(.x)),
.after = GA ) %>%
select(date, year, team, opponent,GF,GA, starts_with("ind"),qatar, prev_date) %>%
rename_at(vars(starts_with("ind_")), function(x)str_remove_all(x,"ind_")) %>%
filter(year > 2017) %>%
ungroup() %>%
filter(is.na(prev_date))
View(tablita)
